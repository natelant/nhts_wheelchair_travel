---
title: "Demographics"
author: "Nate Lant"
date: "11/19/2019"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
library(tidyverse)
library(knitr)
library(haven)
library(nhts2017)
library(plotly)
library(pander)
library(ggpubr)
library(Hmisc)

source("R/functions.R")
source("R/output_functions.R")


knitr::opts_chunk$set(echo = TRUE)
```

## Population
The purpose of drawing conclusions from the NHTS is to provide better transportation--more accessible, safer, faster, etc.--by understanding the transportation patterns of the U.S. citizens.

This page will display the information found in the 2017 NHTS and compare the population of wheelchair users to the able-bodied population. 
<!-- This page also compares the disabled population (those who reported to have a medical condition for longer than six months) in addition to the population of wheelchair users. --> 

In this analysis I use the metric of distribution of relative population. For example
$$ wheelchairpercentage = \frac{counts}{wheelchairpopulation} $$
$$ abledpercentage = \frac{counts}{abledpopulation} $$


### What percent of the respondants use a wheelchair?
Of the U.S. population, it is reported that only ____ percent use wheelchairs. This is approximately ___ hundered americans.

```{r population.wheelchair, echo=F}
# Create a variable that defines "Ability" as "Abled", "Disabled", or "Wheelchair"
nhts_persons %>% left_join(nhts_households, by = "houseid") %>%
  mutate(Ability = case_when(w_chair == "07" | w_mtrchr == "08" ~ "Wheelchair",
                             medcond6 == "02" | medcond6 == "03" ~ "Disabled",  
                             medcond == "02" ~ "Abled"),           # this is only people who reported not having a medical condition.
         UT = ifelse(hhstate == "UT", "Utah", "U.S.")) %>%   
  group_by(UT, Ability) %>% 
  filter(Ability != "NA") %>%
  summarise(survey = n(),
            population = sum(wtperfin)) %>%
  mutate(dist. = population/sum(population)) %>%
  pander()

```

Because there are so few wheelchair users that reported their travel in the 2017 NHTS, we cannot group by state in this analysis.
```{r validate, include=F}
# validate with disabled popoulation
nhts_persons %>%
  mutate(disabled = ifelse(medcond6 == "02", TRUE, FALSE)) %>%
  group_by(disabled) %>% tally()
  
```

### Population by Age
Let's look at how wheelchair users are distributed by age. This can be confusing as it looks like there are more wheelchair users than abled bodies at age 75, but remember it is distribution of wheelchair users to total wheelchair users.

```{r population.age, echo=F}
# build bar chart with age zones %>% into my plotly_bar_nhts function not filtered by age
nhts_persons %>% left_join(nhts_households, by = "houseid") %>%
  mutate(Ability = case_when(w_chair == "07" | w_mtrchr == "08" ~ "Wheelchair",
                             medcond6 == "02" | medcond6 == "03" ~ "Disabled",
                             medcond == "02" ~ "Abled"),
         Age = case_when(r_age >= 00 & r_age < 10 ~ "0 - 10",
                         r_age >= 10 & r_age < 20 ~ "10 - 20",
                         r_age >= 20 & r_age < 30 ~ "20 - 30",
                         r_age >= 30 & r_age < 40 ~ "30 - 40",
                         r_age >= 40 & r_age < 50 ~ "40 - 50",
                         r_age >= 50 & r_age < 60 ~ "50 - 60",
                         r_age >= 60 & r_age < 70 ~ "60 - 70",
                         r_age >= 70 & r_age < 80 ~ "70 - 80",
                         r_age >= 80 & r_age < 90 ~ "80 - 90",
                         r_age >= 90 & r_age < 100 ~ "90 - 100"),
         UT = ifelse(hhstfips == "49", "Utah", "U.S.")) %>%                       # This is filtered by utah
  group_by(UT, Ability, Age) %>%
  filter(Ability != "NA") %>%
  summarise(population = sum(wtperfin)) %>%
  mutate(Distribution = population/sum(population)) %>%
  plotly_bar_nhts_ut(Age, Distribution, "Distribution of Age")

```


```{r population.boxplot, echo=F, warnings=F}
# Show boxplot of age distribution with age on y axis and wheelchair boolean on the x
nhts_persons %>%
  mutate(Ability = case_when(w_chair == "07" | w_mtrchr == "08" ~ "Wheelchair",
                             medcond6 == "02" | medcond6 == "03" ~ "Disabled",
                             medcond == "02" ~ "Abled")) %>%
  filter(r_age > 0, Ability != "NA") %>%
  #group_by(Ability, r_age, r_sex) %>%
  ggplot(aes(x = Ability, y = r_age)) + geom_boxplot(aes(color = r_sex)) +
  stat_compare_means(aes(group = r_sex))
  
```

## Income

```{r income.setup, echo=F}
# Clean the income data and %>% into the barplot
clean_nhts(nhts_persons, nhts_households, "houseid", hhfaminc) %>%
  plotly_bar_nhts(hhfaminc, Distribution, "Distribution of Household Income")

# Output functions
nhts_clean(nhts_persons, nhts_households, "houseid") %>%
  nhts_barplot(hhfaminc, "Distribution of income")

# barplot2
nhts_clean(nhts_persons, nhts_households, "houseid") %>%
  nhts_barplot2(hhfaminc, worker, "Income by worker status")

# test barplot 2
nhts_clean(nhts_persons, nhts_households, "houseid") %>%
  group_by(worker, Ability, hhfaminc) %>% 
    filter(worker > 0,
           hhfaminc > 0) %>%
    summarise(Population = sum(wtperfin)) %>%
    as_factor() %>%
    mutate(Distribution = Population/sum(Population)) %>%
  ggplot( aes(x = hhfaminc, y = Distribution)) + 
    geom_col(aes(fill = Ability), colour = "Black", position = "dodge") +
    ggtitle("title", subtitle = NULL) +
    labs(x = "xlab", y = "ylab") +
    scale_fill_brewer(palette = "PuBuGn", direction = 2) + 
    theme(axis.text.x = element_text(size  = 10, 
                                     angle = 45,
                                     hjust = 1,
                                     vjust = 1)) + 
    facet_wrap(~worker)
  
```



## Employment

```{r employ, echo=F}
clean_nhts(nhts_persons, nhts_households, "houseid", worker) %>%
  plotly_bar_nhts(worker, Distribution, "Worker Status", ylab = "Distribution")
```

## Education

```{r education, echo=F}
clean_nhts(nhts_persons, nhts_households, "houseid", educ) %>%
  plotly_bar_nhts(educ, Distribution, "Education", ylab = "Distribution")

# test the spread function
nhts_clean(nhts_persons, nhts_households, "houseid") %>%
  nhts_distribution(educ, Survey)


```

## Relationship Status

```{r relation, echo=F}
clean_nhts(nhts_persons, nhts_households, "houseid", r_relat) %>%
  plotly_bar_nhts(r_relat, Distribution, "Who filled out the survey?", ylab = "Distribution")
```

## Gender

```{r gender, echo=F}
clean_nhts(nhts_persons, nhts_households, "houseid", r_sex) %>%
  plotly_bar_nhts(r_sex, Distribution, "Distribution of Gender", ylab = "Distribution")
```

## Race

```{r race, echo=F}
clean_nhts(nhts_persons, nhts_households, "houseid", r_race) %>%
  plotly_bar_nhts(r_race, Distribution, "Distribution of Race", ylab = "Distribution")
```


## Housing Density
<!--- HBRESDN --->

## Population Density
<!--- HBPPOPDN --->

## Home Ownership
<!--- Homeown --->

## Personal Opinion of Personal Health
<!---  --->

