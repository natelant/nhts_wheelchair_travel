---
title: "Travel Patterns"
author: "Nate Lant"
date: "12/2/2019"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
library(tidyverse)
library(knitr)
library(haven)
library(nhts2017)
library(plotly)
library(pander)
library(ggpubr)
library(Hmisc)
library(scales)
library(magrittr)
library(reshape2)

source("R/output_functions.R")


knitr::opts_chunk$set(echo = TRUE)
```

## Trip Purpose
According to the 2017 NHTS, trip purpose is different for wheelchair users than for abled users. A histogram below shows the frequency of trips by trip purpose for each of the Ability groups. Only users between the ages of 18 and 65 are considered.

```{r trip.purpose.tryagain, echo=F, message=F, warning=F, fig.width=10, fig.height=6}
# This attempt contains all trips (all households, persons, etc.)
nhts_persons <- nhts_persons %>% mutate(hhpersonid = paste(houseid, personid, sep = "-"),
                                        Ability = case_when(w_chair == "07" | w_mtrchr == "08" ~ "Wheelchair",
                                                            medcond6 == "02" | medcond6 == "03" ~ "Disabled",  
                                                            medcond == "02" ~ "Abled")) %>% 
    filter(r_age >= 18 & r_age < 65,
           Ability != "NA",
           worker > 0)

new_trips <- nhts_trips %>% mutate(hhpersonid = paste(houseid, personid, sep = "-")) %>%
  filter(hhpersonid %in% nhts_persons$hhpersonid) %>%
  group_by(hhpersonid, trippurp) %>%
  tally()   # I don't think I need to tally because the histogram will do that for me.


# builds the grid
new_grid <- expand_grid(hhpersonid = unique(new_trips$hhpersonid), trippurp = unique(new_trips$trippurp)) %>%
  filter(trippurp != "-9")


# combine the grid and the trips then pipe into a histogram
joined_grid_trips <- new_trips %>% right_join(new_grid) %>%
  mutate(n = ifelse(is.na(n), 0, n)) %>%
  left_join(nhts_persons, "hhpersonid") %>% 
  group_by(Ability)

  # pipe into the histogram
plot <-  ggplot(joined_grid_trips, aes(x = n)) + 
  geom_histogram(aes(y = stat(width*density), fill = Ability), binwidth = 0.8, colour = "black", size = .1, position = "dodge") +
    ggtitle("Comparing the number of trips by trip purpose and worker status", subtitle = "01 = Employed and 02 = Unemployed") +
    labs(x = "Number of Trips", y = "Percent of subgroup population") +
    scale_fill_brewer(palette = "PuBuGn", direction = 1) + 
    theme(axis.text.x = element_text(size  = 10, 
                                     angle = 45,
                                     hjust = 1,
                                     vjust = 1)) +
    scale_x_continuous(limits = c(0, 10), breaks = seq(0, 10, 1)) +
    scale_y_continuous(labels = percent_format()) +
    facet_grid(worker ~ trippurp, scales = "free_x")
  
  plot %>% ggplotly(tooltip = c("x", "y", "fill")) %>% layout(boxmode = "group")

```




## Mode Choice



## Trip Length and Trip Time
